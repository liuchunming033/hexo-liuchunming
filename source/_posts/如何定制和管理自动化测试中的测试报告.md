---
title: "如何定制和管理自动化测试报告"
catalog: true
toc_nav_num: true
date: 2019-04-16 19:51:24
subtitle: "基于Pytest+Allure+Django Rest framework+Vue定制和管理自动化测试报告"
header-img: "/img/article_header/computer.jpg"
tags:
- 软件测试
- Allure
catagories:
- 软件测试
---

>对于软件测试来说，测试报告是非常重要的工作产出。一个漂亮、清晰、格式规范的测试报告，不仅能够方便定位缺陷的位置，也方便开发人员和测试人员进行沟通。
 
本篇文章将介绍如何使用开源的测试报告生成框架Allure生成规范、格式统一、美观的测试报告。
通过这篇文章的介绍，你将能够：
 - 将Allure与Pytest测试框架相结合；
 - 定制美观的测试报告；
 - 生成和查看Allure格式的测试报告；
 - 对所有的自动化测试报告进行统一管理。

## 自动化测试报告应该包含哪些内容
自动化测试报告应该自动化测试用例执行完成后自动生成的。我认为，一份完整的自动化测试报告应该包含以下几个方面：
 - *测试总体结论。* 用来标识本次测试是通过还是失败。
 - *测试概要信息。* 用来统计本次测试通过的用例的数量、失败的用例数量、Skipped的用例数量等。
 - *测试用例的执行结果。* 用来表示每条自动化测试用例是通过还是失败，如果失败，测试用例具体失败在哪一行。
 - *测试执行时长。* 表示本次测试花了多长时间。
 - *测试环境信息。* 表示本次测试相关的测试配置和测试环境。
 
## 安装Allure及Pytest插件
 [Allure](http://allure.qatools.ru/)是一款非常轻量级并且非常灵活的开源测试报告生成框架。 它支持绝大多数测试框架， 例如TestNG、Pytest、JUint等。它简单易用，易于集成。下面就Pytest如何与Allure集成做详细介绍。
安装Allure
```
brew install allure
```
Pytest是Python的单元测试框架，非常方便和易用。强烈推荐对于用Python进行测试工作的小伙伴使用这个测试框架，相比与Python自带的UnitTest好用太多太多。后面我将用一整篇文章介绍Pytest测试框架。今天我们主要是介绍如何将测试报告生成工具Allure集成到Pytest中。

[allure-pytest](https://pypi.org/project/allure-pytest/)是Pytest的Allure插件，通过它可以生成Allure所需要的用于生成测试报告的数据。安装方法：
```
$ pip install allure-pytest
```
这样有关测试报告用到的库都已经安装好了。接下来我们来定制我们的测试报告吧。
## 定制测试报告内容
pytest-allure-adaptor官网中详细介绍了pytest-allure-adaptor所具有的功能。本篇文章不会再翻译一遍，而是从实际入手，给大家介绍如何将其应用到自己的框架中。
为了使用Allure生成报告，需要在conftest.py和测试脚本中加入Allure特性。

首先，conftest.py中可以通过allure.environment方法将测试环境的信息输出到报告中，比如将测试时用的host和测试用的browser添加到测试报告中：
```
#!/usr/bin/env python
# coding=utf-8

import pytest
import allure
import yaml

@pytest.fixture(scope="session", autouse=True)
def env(request):
    """
    Parse env config info
    """
    root_dir = request.config.rootdir
    config_path = '{0}/config/env_config.yml'.format(root_dir)
    with open(config_path) as f:
        env_config = yaml.load(f) # 读取配置文件

    allure.environment(host=env_config['host']['domain']) # 测试报告中展示host
    allure.environment(browser=env_config['host']['browser']) # 测试报告中展示browser

    return env_config

```
接着，在测试脚本中，添加allure特性，直接看下面的脚本，我通过在脚本中添加注释的方式给大家解释allure特性的用途。比如测试脚本是test_shopping_trolley.py：
```
#!/usr/bin/env python
# coding=utf-8

import pytest
import allure


@allure.feature('购物车功能')  # feature定义功能
class TestShoppingTrolley(object):
    @allure.story('加入购物车')  # story定义用户场景
    def test_add_shopping_trolley(self):
        login('刘春明', '密码')  # 调用“步骤函数”
        with allure.step("浏览商品"):  # 将一个测试用例分成几个步骤，将步骤打印到测试报告中，步骤2
            allure.attach('商品1', '刘春明')  # attach可以打印一些附加信息
            allure.attach('商品2', 'liuchunming')
        with allure.step("点击商品"):  # 将一个测试用例分成几个步骤，将步骤打印到测试报告中，步骤3
            pass
        with allure.step("校验结果"):
            allure.attach('期望结果', '添加购物车成功')
            allure.attach('实际结果', '添加购物车失败')
            assert 'success' == 'failed'

    @allure.story('修改购物车')
    def test_edit_shopping_trolley(self):
        pass

    @pytest.mark.skipif(reason='本次不执行')
    @allure.story('删除购物车')
    def test_delete_shopping_trolley(self):
        pass


@allure.step('用户登录')  # 还可以将一个函数作为一个步骤，调用此函数时，报告中输出一个步骤，步骤名字通常是函数名，我把这样的函数叫“步骤函数”
def login(user, pwd):
    print(user, pwd)

```
上面使用了Allure的几个特性：

 - @allure.feature # 用于定义被测试的功能，被测产品的需求点
 - @allure.story # 用于定义被测功能的用户场景，即子功能点
 - with allure.step # 用于将一个测试用例，分成几个步骤在报告中输出
 - allure.attach # 用于向测试报告中输入一些附加的信息，通常是一些测试数据信息
 - @allure.step # 用于将一些通用的函数作为测试步骤输出到报告，调用此函数的地方会向报告中输出步骤
 - allure.environment # pytest暂不支持

## 生成Allure测试报告
### 生成报告原始数据
测试用例中添加了Allure特性之后，在执行测试的时候需要先生成Allure报告所需要的测试结果数据。在py.test执行测试的时候，指定--alluredir选项及测试数据保存的目录即可：
```
$ py.test test/ --alluredir ./result/
```
另外，还可以执行指定features或者stories执行一部分测试用例，比如执行‘购物车功能’下的‘加入购物车’子功能的测试用例：
```
$ py.test test/ --allure_features='购物车功能' --allure_stories='加入购物车' --alluredir ./result/
```
### 生成allure格式测试报告
./result/中保存了测试结果数据。接着，执行利用上面命令产生的测试结果数据./result/生成Allure测试报告：
```shell
$ allure generate ./result/ -o ./report/ --clean
```
可以通过下面的命令打开测试报告：
```
$ allure open -h 127.0.0.1 -p 8083 ./report/
```
在浏览器打开http://127.0.0.1:8083网页，展示测试报告。

## 测试报告解读
打开生成的测试报告后，浏览器被自动调起，展示测试报告。下面我们分别看看测试报告的几个页面。

 1. 首页
![这里写图片描述](http://img.blog.csdn.net/20180320200100881?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
首页中展示了本次测试的测试用例数量，成功用例、失败用例、跳过用例的比例，测试环境信息，SUITES，FEATURES BY STORIES等基本信息，当与Jenkins做了持续置成后，TREND区域还将显示，历次测试的通过情况。
首页的左边栏，还从不同的维度展示测试报告的其他信息，大家可以自己点进去看看。
 2. Behaviors
接下来，我们点击一下FEATURES BY STORIES，将进入Behaviors页面，这个页面按照FEATURES和 STORIES展示测试用例的执行结果：
![这里写图片描述](http://img.blog.csdn.net/20180320200600472?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
从这个页面可以看到“购物车功能”这个FEATURES包含的三个STORIES的测试用例执行情况。
 3. Suites
Allure测试报告将每一个测试脚本，作为一个Suite。在首页点击Suites区域下面的任何一条Suite，都将进入Suites页面。
![这里写图片描述](http://img.blog.csdn.net/20180320201059219?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
这个页面，将脚本的目录结果展示本次所有的测试用例执行情况。
 4. 测试用例页面
 在Suites页面上点击任何一条测试用例，Suites页面的右侧将展示这条用例的详细执行情况。
![这里写图片描述](http://img.blog.csdn.net/20180320201409629?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
从这个页面可以看到测试用例执行的每一个步骤，以及每个步骤的执行结果。测试用例为什么失败，这里一目了然。

### 利用Jenkins生成测试报告
前面我们通过命令行方法生成测试报告，通常是在本地调试时候使用。而真正的自动化测试一定是与持续集成相结合的，比如利用Jenkins进行测试的自动执行。
要想在持续集成中自动生成测试报告，首先需要给Jenkins安装Allure Plugin。在Jenkins的插件管理页面，搜索“allure”，在搜索结果页，选择“Allure Jenkins Plugin”进行安装。
安装完成之后重启一下Jenkins。
在Jenkins的“全局工具管理”页面，找到Allure Commandline模块进行安装：
![这里写图片描述](http://img.blog.csdn.net/20180320175830037?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
点击后，弹出下面的页面，输入Allure的命令别名和版本后，点击Apply 和Save。
![这里写图片描述](http://img.blog.csdn.net/20180320180250524?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
按照下面的图示，在Excute Shell和构建后操作部分写上对应的配置信息，即可。
![这里写图片描述](http://img.blog.csdn.net/20180320182135772?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)
这样，我们的Jenkins Job执行完测试用例时候，将在Job的主页面上看到Allure Report图标，点击进去就看到了Allure Report报告。
![这里写图片描述](http://img.blog.csdn.net/20180320182403557?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGl1Y2h1bm1pbmcwMzM=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)

团队内部可能不同项目使用的测试框架不一样，每个测试框架生成的测试报告也不一样。但由于Allure报告支持很多测试框架，通过Allure可以生成格式一致的测试报告，这就对外提供格式一致的测试报告提供了方便。
建议：团队内部都采用Allure生成测试报告。
由于团队内部有的项目采用的Java+TestNG的测试架构，后面有时间，我将会介绍一下如何在TestNG框架如何集成Allure。

## 测试报告管理平台
我们希望能够把历次的测试报告进行存档和保留，方便以后查看或者对软件的质量进行度量。
下面我们就来基于Django REST framework和Vue来实现测试报告的展示和管理平台
### 测试报告元数据
用pytest-json-report可以获得测试报告的生成时间、测试的结果、测试执行时间、每条测试用例的结果以及测试用例失败的原因。
### 测试报告静态网页
通过接口上传到文件服务器
### 编写前端页面
Vue
### 用Nginx做反向代理
根据location代理到文件服务器
### 部署

## 总结
总结前面的实践，展望：自动生成BUG候选列表，与JIRA对接。